name: Test

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download ACT Bundle
      run: |
        $url = "https://advancedcombattracker.com/download.php?id=57"
        Invoke-WebRequest -Uri $url -OutFile ACT-Bundle.zip

    - name: Extract ACT Files
      run: |
        Expand-Archive -Path ACT-Bundle.zip -DestinationPath "C:\Program Files (x86)\Advanced Combat Tracker\"
        dir "C:\Program Files (x86)\Advanced Combat Tracker"

    - name: Setup Build Environment
      run: |
        echo "C:\Program Files (x86)\Advanced Combat Tracker\" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
        echo "C:\Program Files (x86)\Advanced Combat Tracker\" > referencepath.txt

    - name: Build Solution
      run: |
        nuget restore NEO_ACT_Plugin.sln
        msbuild NEO_ACT_Plugin.sln ^
          /p:Configuration=Release ^
          /p:Platform="Any CPU" ^
          /p:ReferencePath="C:\Program Files (x86)\Advanced Combat Tracker\"

    - name: Run Tests
      run: |
        vstest.console.exe "NEO_ACT_Plugin.Test\bin\Release\NEO_ACT_Plugin.Test.dll"