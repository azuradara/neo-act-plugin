name: .NET Framework Tests

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-and-test:
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v1.1
    
    - name: Setup NuGet
      uses: NuGet/setup-nuget@v1
    
    - name: Restore NuGet packages
      run: nuget restore
    
    - name: Download and Extract ACT
      shell: powershell
      run: |
        $url = "https://advancedcombattracker.com/download.php?id=57"
        $outputPath = "$env:TEMP\ACT.zip"
        
        Invoke-WebRequest -Uri $url -OutFile $outputPath
        
        $actTargetDir = "C:\Program Files (x86)\Advanced Combat Tracker"
        if (-not (Test-Path $actTargetDir)) {
            New-Item -ItemType Directory -Path $actTargetDir -Force
        }
        
        Expand-Archive -Path $outputPath -DestinationPath $actTargetDir -Force
        
        Get-ChildItem -Path $actTargetDir
        
        if (-not (Test-Path "$actTargetDir\Advanced Combat Tracker.exe")) {
            Write-Error "Advanced Combat Tracker.exe not found at $actTargetDir\Advanced Combat Tracker.exe"
            exit 1
        }
    
    - name: Build solution
      run: msbuild /p:Configuration=Release /p:Platform="Any CPU" NEO_ACT_Plugin.csproj
    
    - name: Run tests
      shell: powershell
      run: |
        $testDll = ".\bin\Release\NEO_ACT_Plugin.dll"
        
        if (Test-Path "C:\Program Files (x86)\Microsoft Visual Studio\2019\Enterprise\Common7\IDE\Extensions\TestPlatform\vstest.console.exe") {
            & "C:\Program Files (x86)\Microsoft Visual Studio\2019\Enterprise\Common7\IDE\Extensions\TestPlatform\vstest.console.exe" $testDll
        } elseif (Test-Path "$(vswhere -latest -products * -requires Microsoft.VisualStudio.PackageGroup.TestTools.Core -property installationPath)\Common7\IDE\Extensions\TestPlatform\vstest.console.exe") {
            & "$(vswhere -latest -products * -requires Microsoft.VisualStudio.PackageGroup.TestTools.Core -property installationPath)\Common7\IDE\Extensions\TestPlatform\vstest.console.exe" $testDll
        } else {
            Write-Host "VSTest not found. Install it or use another test runner."
        }